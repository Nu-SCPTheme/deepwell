language: rust
rust:
  - stable
  - beta
  - nightly

os:
  - linux
  - osx
  - windows

env:
  - DATABASE_URL=postgres://overseer:blackmoon@localhost/deepwell

services:
  - postgresql

addons:
  postgresql: '10'
  apt:
    packages:
      - postgresql-10
      - postgresql-client-10

before_script:
  # Add rustfmt
  - rustup component add rustfmt
  # Add clippy
  - .travis/clippy.sh setup
  # Setup database
  - .travis/database.sh setup

script:
  # Ensure code is rustfmt'd
  - .travis/banner.sh rustfmt
  - rustfmt --edition=2018 src/lib.rs --check
  # Check clippy lints
  - .travis/banner.sh clippy
  - .travis/clippy.sh check
  # Run build
  - .travis/banner.sh build
  - cargo build --release
  # Test migrations
  - .travis/banner.sh diesel
  - .travis/database.sh check
  # Run tests
  - .travis/banner.sh tests
  - .travis/database.sh test
  # Build documentation
  - .travis/banner.sh docs
  - cargo doc --no-deps

jobs:
  allow_failures:
    - rust: nightly
    - os: windows
  fast_finish: true

notifications:
  email:
    on_success: change
    on_failure: always
